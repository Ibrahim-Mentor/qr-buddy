<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        // Configure Tailwind with the new color scheme from Image 1
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'brand-dark': '#0d071a',
                        'brand-light': '#1a0e38',
                        'brand-pink': '#e45b8b',
                        'brand-purple': '#c058f3',
                        'brand-yellow': '#f5d143', // From Image 2 for scanner
                    },
                    backgroundImage: {
                        'brand-gradient': 'linear-gradient(to right, #c058f3, #e45b8b)',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }

        /* Page transition styles */
        .page {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            will-change: opacity, transform;
        }

        .page-hidden {
            opacity: 0;
            transform: scale(0.98);
            pointer-events: none;
        }

        /* Custom glassmorphism card style */
        .card {
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom input styles */
        .input-glass {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        .input-glass::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        .input-glass:focus {
            outline: none;
            border-color: #c058f3;
            box-shadow: 0 0 0 2px #c058f3;
        }
        select.input-glass {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.4)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            padding-right: 3rem;
        }
        
        /* Custom color picker */
        input[type="color"] {
            -webkit-appearance: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            height: 48px;
            border-radius: 0.5rem;
            cursor: pointer;
            overflow: hidden;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
        }

        /* Scanner overlay */
        #scanner-frame {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 75vw;
            height: 75vw;
            max-width: 300px;
            max-height: 300px;
            border-radius: 1.5rem;
            box-shadow: 0 0 0 6px #f5d143, inset 0 0 0 6px #f5d143;
        }
        #scanner-line {
            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            height: 2px;
            background: #f5d143;
            box-shadow: 0 0 10px #f5d143;
            animation: scan 2.5s infinite ease-in-out;
        }

        @keyframes scan {
            0% { transform: translateY(-100px); opacity: 0.5; }
            50% { transform: translateY(100px); opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0.5; }
        }

        /* Notification */
        #clipboard-notification {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-brand-light to-brand-dark text-white antialiased h-[100dvh] w-screen overflow-hidden">

    <div id="clipboard-notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50">
        Copied to clipboard!
    </div>
    
    <div class="relative h-full w-full">

        <div id="page-welcome" class="page fixed inset-0 flex flex-col items-center justify-between p-8">
            <div class="flex-grow flex flex-col items-center justify-center text-center">
                <div class="w-32 h-32 card rounded-3xl flex items-center justify-center mb-8">
                    <svg class="w-20 h-20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 013.75 9.375v-4.5zM3.75 14.625c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 013.75 19.125v-4.5zM13.5 4.875c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 0113.5 9.375v-4.5z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 14.625c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 0113.5 19.125v-4.5z" />
                    </svg>
                </div>
                <h1 class="text-4xl font-bold mb-4">Get Started</h1>
                <p class="text-lg text-white/70 max-w-xs">Your all-in-one solution for scanning and generating QR codes.</p>
            </div>
            <button id="btn-start" class="w-full max-w-xs bg-brand-gradient text-white font-semibold py-4 px-6 rounded-full shadow-lg transition-transform duration-200 hover:scale-105 active:scale-95">
                Start
            </button>
        </div>

        <div id="page-main" class="page page-hidden fixed inset-0 flex flex-col items-center justify-center p-8 space-y-6">
            <h1 class="text-4xl font-bold text-center mb-12">QR Suite</h1>
            <button id="btn-goto-scan" class="w-full max-w-xs card rounded-2xl p-6 flex flex-col items-center space-y-4 transition-transform duration-200 hover:scale-105 active:scale-95">
                <svg class="w-12 h-12 bg-brand-gradient rounded-full p-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 013.75 9.375v-4.5zM3.75 14.625c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 013.75 19.125v-4.5zM13.5 4.875c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 0113.5 9.375v-4.5zM13.5 14.625c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 0113.5 19.125v-4.5z" />
                </svg>
                <span class="text-xl font-semibold">Scan QR Code</span>
            </button>
            <button id="btn-goto-generate" class="w-full max-w-xs card rounded-2xl p-6 flex flex-col items-center space-y-4 transition-transform duration-200 hover:scale-105 active:scale-95">
                <svg class="w-12 h-12 bg-brand-gradient rounded-full p-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                <span class="text-xl font-semibold">Generate QR Code</span>
            </button>
            <button id="btn-goto-history" class="w-full max-w-xs card rounded-2xl py-3 px-6 text-center text-white/70 transition-colors hover:text-white">
                View History
            </button>
        </div>

        <div id="page-scan" class="page page-hidden fixed inset-0 flex flex-col bg-black">
            <div class="absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-10 bg-black/30">
                <button class="btn-back p-2 rounded-full hover:bg-white/20">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                <div class="flex space-x-4">
                    <button class="p-2 rounded-full hover:bg-white/20">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                        </svg>
                    </button>
                    <button class="p-2 rounded-full hover:bg-white/20">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 00-3.7-3.7 48.678 48.678 0 00-7.324 0 4.006 4.006 0 00-3.7 3.7c-.092 1.21-.138 2.43-.138 3.662s.046 2.453.138 3.662a4.006 4.006 0 003.7 3.7 48.656 48.656 0 007.324 0 4.006 4.006 0 003.7-3.7c.092-1.21.138-2.43.138-3.662zM12 12V9m0 3v3m0-3h3m-3 0H9" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="relative w-full flex-grow overflow-hidden">
                <video id="scan-video" playsinline class="w-full h-full object-cover" style="transform: scaleX(-1);"></video>
                <canvas id="scan-canvas" class="hidden"></canvas>
                <div id="scanner-frame">
                    <div id="scanner-line"></div>
                </div>
            </div>
             <div class="p-6 flex justify-center items-center z-10 bg-black/30">
                <button id="btn-stop-scan" class="w-16 h-16 bg-brand-yellow rounded-full flex items-center justify-center text-black/70">
                    <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
                    </svg>
                </button>
            </div>
        </div>

        <div id="page-generate" class="page page-hidden fixed inset-0 flex flex-col p-6 overflow-y-auto">
            <div class="flex items-center mb-6 flex-shrink-0">
                <button class="btn-back p-2 -ml-2 rounded-full hover:bg-white/10">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                <h1 class="text-2xl font-semibold ml-2">Generate Code</h1>
            </div>

            <div class="flex flex-col items-center mb-6 card rounded-2xl p-6">
                <div id="qr-canvas-generate" class="w-full max-w-[200px] h-[200px] bg-white rounded-lg flex items-center justify-center">
                    </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="qr-data" class="block text-sm font-medium text-white/70 mb-2">Data (URL, text, etc.)</label>
                    <textarea id="qr-data" rows="3" class="w-full input-glass rounded-lg p-3" placeholder="https://example.com"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="dot-style" class="block text-sm font-medium text-white/70 mb-2">Dot Style</label>
                        <select id="dot-style" class="w-full input-glass rounded-lg p-3">
                            <option value="square">Square</option>
                            <option value="dots">Dots</option>
                            <option value="rounded">Rounded</option>
                            <option value="extra-rounded">Extra Rounded</option>
                            <option value="classy">Classy</option>
                            <option value="classy-rounded">Classy Rounded</option>
                        </select>
                    </div>
                    <div>
                        <label for="corner-square-style" class="block text-sm font-medium text-white/70 mb-2">Corner Style</label>
                        <select id="corner-square-style" class="w-full input-glass rounded-lg p-3">
                            <option value="square">Square</option>
                            <option value="dot">Dot</option>
                            <option value="extra-rounded">Extra Rounded</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-white/70 mb-2">Dots</label>
                        <input id="dot-color" type="color" value="#c058f3">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-white/70 mb-2">Background</label>
                        <input id="bg-color" type="color" value="#ffffff">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-white/70 mb-2">Corners</label>
                        <input id="corner-dot-color" type="color" value="#0d071a">
                    </div>
                </div>

                <div>
                    <label for="logo-upload" class="block text-sm font-medium text-white/70 mb-2">Embed Logo (Optional)</label>
                    <input id="logo-upload" type="file" accept="image/png, image/jpeg, image/svg+xml" class="w-full text-sm text-white/70 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-brand-gradient file:text-white hover:file:opacity-90 transition-all duration-150 ease-in-out">
                    <button id="clear-logo" class="text-xs text-brand-pink hover:text-brand-pink/80 mt-2">Clear Logo</button>
                </div>
                
                <button id="btn-save-generated" class="w-full bg-brand-gradient text-white font-semibold py-4 px-6 rounded-full shadow-lg transition-transform duration-200 hover:scale-105 active:scale-95">
                    Save & View Code
                </button>
            </div>
        </div>
        
        <div id="page-result" class="page page-hidden fixed inset-0 flex flex-col p-6 overflow-y-auto">
            <div class="flex items-center mb-6 flex-shrink-0">
                <button class="btn-back p-2 -ml-2 rounded-full hover:bg-white/10">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                <h1 class="text-2xl font-semibold ml-2">QR Code</h1>
            </div>

            <div class="flex-grow flex flex-col justify-center space-y-6">
                <div class="flex flex-col items-center card rounded-2xl p-6">
                    <div id="qr-canvas-result" class="w-full max-w-[256px] h-[256px] bg-white rounded-lg flex items-center justify-center">
                        </div>
                </div>

                <div class="card rounded-2xl p-6 space-y-2">
                    <label class="text-sm font-medium text-white/70">Data</label>
                    <p id="result-data-text" class="text-lg break-all">https://example.com</p>
                </div>

                <div class="card rounded-full p-2 flex justify-around items-center">
                    <button id="btn-copy-result" class="p-4 rounded-full hover:bg-white/10 transition-colors">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.03 1.125 0 1.131.094 1.976 1.057 1.976 2.192V7.5m-9 3v5.25A2.25 2.25 0 006.75 18h10.5a2.25 2.25 0 002.25-2.25V10.5m-12 0h12" />
                        </svg>
                    </button>
                    <button id="btn-share-result" class="p-4 rounded-full hover:bg-white/10 transition-colors">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 100-2.186m0 2.186c-.18-.324-.283-.696-.283-1.093s.103-.77.283-1.093m0 2.186l-9.566-5.314" />
                        </svg>
                    </button>
                    <button id="btn-download-png" class="p-4 rounded-full hover:bg-white/10 transition-colors">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                    </button>
                    <button id="btn-download-svg" class="p-4 rounded-full hover:bg-white/10 transition-colors">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m3 0H3.75M17.25 7.5l3 2.25-3 2.25m3 0h-3.75M13.5 19.5h-3m3 0V4.5" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="page-history" class="page page-hidden fixed inset-0 flex flex-col p-6 overflow-y-auto">
            <div class="flex items-center mb-6 flex-shrink-0">
                <button class="btn-back p-2 -ml-2 rounded-full hover:bg-white/10">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                <h1 class="text-2xl font-semibold ml-2">History</h1>
            </div>

            <div class="flex-grow space-y-6">
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-semibold text-white">Generated</h2>
                        <button id="clear-generated-history" class="text-sm text-brand-pink hover:text-brand-pink/80">Clear All</button>
                    </div>
                    <div id="generated-history-list" class="space-y-3">
                        </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-semibold text-white">Scanned</h2>
                        <button id="clear-scanned-history" class="text-sm text-brand-pink hover:text-brand-pink/80">Clear All</button>
                    </div>
                    <div id="scanned-history-list" class="space-y-3">
                        </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- LocalStorage Keys ---
            const GENERATED_HISTORY_KEY = 'qrHistory_generated';
            const SCANNED_HISTORY_KEY = 'qrHistory_scanned';

            // --- QR Scanner State Variables ---
            let animationFrameId = null;
            let stream = null;
            
            // --- QR Instance ---
            let currentQRData = "https://example.com";
            
            // Initialize QR Code Styling for Generator
            const qrCanvasGenerate = document.getElementById('qr-canvas-generate');
            const qrCodeGenerate = new QRCodeStyling({
                width: 200,
                height: 200,
                data: currentQRData,
                dotsOptions: { color: "#c058f3", type: "square" },
                backgroundOptions: { color: "#ffffff" },
                cornersSquareOptions: { type: "square" },
                cornersDotOptions: { color: "#0d071a" },
                imageOptions: { crossOrigin: "anonymous", margin: 5, imageSize: 0.4 }
            });
            qrCodeGenerate.append(qrCanvasGenerate);
            
            // Initialize QR Code Styling for Result Page
            const qrCanvasResult = document.getElementById('qr-canvas-result');
            const qrCodeResult = new QRCodeStyling({
                width: 256,
                height: 256,
                data: currentQRData,
                dotsOptions: { color: "#c058f3", type: "square" },
                backgroundOptions: { color: "#ffffff" },
                cornersSquareOptions: { type: "square" },
                cornersDotOptions: { color: "#0d071a" },
                imageOptions: { crossOrigin: "anonymous", margin: 5, imageSize: 0.4 }
            });
            qrCodeResult.append(qrCanvasResult);

            // --- Page Navigation ---
            const pages = document.querySelectorAll('.page');
            
            function showPage(pageId) {
                // Stop scanning when leaving scan page
                if (pageId !== 'page-scan' && stream) {
                    stopScanStream();
                }
                
                pages.forEach(page => {
                    if (page.id === pageId) {
                        page.classList.remove('page-hidden');
                    } else {
                        page.classList.add('page-hidden');
                    }
                });
            }

            // Navigation Event Listeners
            document.getElementById('btn-start').addEventListener('click', () => showPage('page-main'));
            document.getElementById('btn-goto-scan').addEventListener('click', () => {
                showPage('page-scan');
                startScan(); // Auto-start scan
            });
            document.getElementById('btn-goto-generate').addEventListener('click', () => showPage('page-generate'));
            document.getElementById('btn-goto-history').addEventListener('click', () => {
                renderHistory();
                showPage('page-history');
            });

            document.querySelectorAll('.btn-back').forEach(btn => {
                btn.addEventListener('click', () => showPage('page-main'));
            });
            
            document.getElementById('btn-stop-scan').addEventListener('click', () => {
                stopScanStream();
                showPage('page-main');
            });


            // --- Helper Functions ---
            const notificationEl = document.getElementById('clipboard-notification');
            let notificationTimer;

            function showNotification(message, isError = false) {
                clearTimeout(notificationTimer);
                notificationEl.textContent = message;
                notificationEl.classList.toggle('bg-green-500', !isError);
                notificationEl.classList.toggle('bg-red-500', isError);
                notificationEl.classList.remove('opacity-0', 'translate-y-2');
                notificationEl.classList.add('opacity-100', 'translate-y-0');
                
                notificationTimer = setTimeout(() => {
                    notificationEl.classList.remove('opacity-100', 'translate-y-0');
                    notificationEl.classList.add('opacity-0', 'translate-y-2');
                }, 2000);
            }

            function copyToClipboard(text) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(() => {
                        showNotification('Copied to clipboard!');
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                        showNotification('Failed to copy!', true);
                    });
                } else {
                    // Fallback for insecure contexts
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed"; 
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showNotification('Copied to clipboard!');
                    } catch (err) {
                        console.error('Fallback copy failed: ', err);
                        showNotification('Failed to copy!', true);
                    }
                    document.body.removeChild(textArea);
                }
            }

            function loadHistory(key) {
                const history = localStorage.getItem(key);
                return history ? JSON.parse(history) : [];
            }

            function saveHistory(key, history) {
                localStorage.setItem(key, JSON.stringify(history));
            }

            function formatHistoryTimestamp(isoString) {
                const date = new Date(isoString);
                return date.toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' });
            }
            
            // --- Update Result Page ---
            function showResultPage(data) {
                currentQRData = data; // Store data for downloads
                
                // Update QR code on result page
                const options = qrCodeGenerate.options; // Get current style from generator
                qrCodeResult.update({
                    data: data,
                    dotsOptions: options.dotsOptions,
                    backgroundOptions: options.backgroundOptions,
                    cornersSquareOptions: options.cornersSquareOptions,
                    cornersDotOptions: options.cornersDotOptions,
                    image: options.image,
                });
                
                // Update data text
                document.getElementById('result-data-text').textContent = data;
                
                // Show the page
                showPage('page-result');
            }


            // --- History Rendering & Logic ---
            const generatedHistoryList = document.getElementById('generated-history-list');
            const scannedHistoryList = document.getElementById('scanned-history-list');

            function renderHistory() {
                // Render Generated History
                const genHistory = loadHistory(GENERATED_HISTORY_KEY);
                generatedHistoryList.innerHTML = '';
                if (genHistory.length === 0) {
                    generatedHistoryList.innerHTML = '<p class="text-white/50 text-sm">No generated history yet.</p>';
                } else {
                    genHistory.forEach(item => {
                        generatedHistoryList.appendChild(createHistoryElement(item, 'generated'));
                    });
                }

                // Render Scanned History
                const scanHistory = loadHistory(SCANNED_HISTORY_KEY);
                scannedHistoryList.innerHTML = '';
                if (scanHistory.length === 0) {
                    scannedHistoryList.innerHTML = '<p class="text-white/50 text-sm">No scanned history yet.</p>';
                } else {
                    scanHistory.forEach(item => {
                        scannedHistoryList.appendChild(createHistoryElement(item, 'scanned'));
                    });
                }
            }
            
            function createHistoryElement(item, type) {
                const el = document.createElement('div');
                el.className = 'history-item card p-4 rounded-lg cursor-pointer transition-colors hover:bg-white/20';
                el.dataset.historyData = item.data;
                el.dataset.historyType = type;
                el.innerHTML = `
                    <p class="history-data text-white font-medium break-all truncate">${item.data}</p>
                    <p class="text-xs text-white/50 mt-1">${formatHistoryTimestamp(item.timestamp)}</p>
                `;
                el.addEventListener('click', () => {
                    // Re-use the generator's settings for consistency
                    updateQRCode(item.data); // Update generator
                    dataInput.value = item.data; // Update generator input
                    showResultPage(item.data); // Show result page
                });
                return el;
            }

            // Clear history buttons
            document.getElementById('clear-generated-history').addEventListener('click', () => {
                saveHistory(GENERATED_HISTORY_KEY, []);
                renderHistory();
            });
            document.getElementById('clear-scanned-history').addEventListener('click', () => {
                saveHistory(SCANNED_HISTORY_KEY, []);
                renderHistory();
            });

            // --- QR Generator Logic ---
            const dataInput = document.getElementById('qr-data');
            const dotStyleSelect = document.getElementById('dot-style');
            const cornerSquareSelect = document.getElementById('corner-square-style');
            const dotColorInput = document.getElementById('dot-color');
            const bgColorInput = document.getElementById('bg-color');
            const cornerDotColorInput = document.getElementById('corner-dot-color');
            const logoUpload = document.getElementById('logo-upload');
            const clearLogoBtn = document.getElementById('clear-logo');
            const saveGeneratedBtn = document.getElementById('btn-save-generated');

            let logoImage = null;
            dataInput.value = currentQRData; // Set initial value

            // Function to update QR code
            function updateQRCode(dataOverride) {
                const data = dataOverride || dataInput.value || " ";
                currentQRData = data; // Keep track of current data
                
                qrCodeGenerate.update({
                    data: data,
                    image: logoImage,
                    dotsOptions: {
                        color: dotColorInput.value,
                        type: dotStyleSelect.value
                    },
                    backgroundOptions: {
                        color: bgColorInput.value
                    },
                    cornersSquareOptions: {
                        type: cornerSquareSelect.value
                    },
                    cornersDotOptions: {
                        color: cornerDotColorInput.value
                    }
                });
            }

            // Event Listeners for generator
            [dataInput, dotStyleSelect, cornerSquareSelect, dotColorInput, bgColorInput, cornerDotColorInput].forEach(el => {
                el.addEventListener('input', () => updateQRCode());
                el.addEventListener('change', () => updateQRCode());
            });

            logoUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        logoImage = reader.result;
                        updateQRCode();
                    };
                    reader.readAsDataURL(file);
                }
            });

            clearLogoBtn.addEventListener('click', () => {
                logoImage = null;
                logoUpload.value = ''; // Clear file input
                updateQRCode();
            });

            saveGeneratedBtn.addEventListener('click', () => {
                const data = dataInput.value;
                if (!data || data.trim() === '') {
                    showNotification('Cannot save empty data!', true);
                    return;
                }
                const history = loadHistory(GENERATED_HISTORY_KEY);
                // Prevent duplicates
                if (!history.find(item => item.data === data)) {
                    history.unshift({ data: data, timestamp: new Date().toISOString() });
                    saveHistory(GENERATED_HISTORY_KEY, history);
                }
                
                showResultPage(data); // Show the result page
            });
            
            // --- Result Page Actions ---
            document.getElementById('btn-copy-result').addEventListener('click', () => {
                copyToClipboard(currentQRData);
            });
            
            document.getElementById('btn-share-result').addEventListener('click', () => {
                if (navigator.share) {
                    navigator.share({
                        title: 'QR Code Data',
                        text: currentQRData,
                    }).catch(err => console.error('Share failed:', err));
                } else {
                    showNotification('Share not supported on this device.', true);
                }
            });

            document.getElementById('btn-download-png').addEventListener('click', () => {
                qrCodeResult.download({ name: 'qr-code', extension: 'png' });
            });

            document.getElementById('btn-download-svg').addEventListener('click', () => {
                qrCodeResult.download({ name: 'qr-code', extension: 'svg' });
            });


            // --- QR Scanner Logic ---
            const video = document.getElementById('scan-video');
            const canvasEl = document.getElementById('scan-canvas');
            const canvas = canvasEl.getContext('2d');

            async function startScan() {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' }
                    });
                    
                    video.srcObject = stream;
                    video.setAttribute('playsinline', true);
                    video.play();
                    
                    animationFrameId = requestAnimationFrame(tick);

                } catch (err) {
                    console.error("Error accessing camera:", err);
                    showPage('page-main'); // Go back to main menu
                    showNotification('Error: Could not access camera.', true);
                }
            }

            function stopScanStream() {
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                video.srcObject = null;
            }

            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvasEl.height = video.videoHeight;
                    canvasEl.width = video.videoWidth;
                    canvas.drawImage(video, 0, 0, canvasEl.width, canvasEl.height);
                    
                    try {
                        const imageData = canvas.getImageData(0, 0, canvasEl.width, canvasEl.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "dontInvert",
                        });

                        if (code) {
                            stopScanStream(); // Stop after successful scan
                            
                            // Save to history
                            const history = loadHistory(SCANNED_HISTORY_KEY);
                            if (!history.find(item => item.data === code.data)) {
                                history.unshift({ data: code.data, timestamp: new Date().toISOString() });
                                saveHistory(SCANNED_HISTORY_KEY, history);
                            }
                            
                            // Show result page
                            // We need to update the generator settings to match the scan
                            // For simplicity, we'll just use the default style for a scanned code
                            dataInput.value = code.data; // Update generator input
                            updateQRCode(code.data); // Update generator QR
                            showResultPage(code.data); // Show result page
                            
                            return; // Stop the tick loop
                        }
                    } catch (err) {
                        console.error("jsQR error:", err);
                    }
                }
                
                if (animationFrameId) {
                    animationFrameId = requestAnimationFrame(tick);
                }
            }
            
            // --- Initial Load ---
            showPage('page-welcome'); // Start on the welcome page
            updateQRCode(); // Run once on load to show the default QR code
        });
    </script>
</body>
</html>