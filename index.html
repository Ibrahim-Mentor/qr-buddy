<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        // Configure Tailwind with the new color scheme
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'brand-dark': '#0d071a',
                        'brand-light': '#1a0e38',
                        'brand-pink': '#e45b8b',
                        'brand-purple': '#c058f3',
                        'brand-yellow': '#f5d143', // From scanner reference
                    },
                    backgroundImage: {
                        'brand-gradient': 'linear-gradient(to right, #c058f3, #e45b8b)',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            background-color: #0d071a;
        }
        
        /* Glassmorphism card style */
        .card {
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Page transition styles */
        .page {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            will-change: opacity, transform;
            position: fixed;
            inset: 0;
            opacity: 1;
            transform: scale(1);
        }
        .page-hidden {
            opacity: 0;
            transform: scale(0.98);
            pointer-events: none;
        }

        /* App pages (for tab bar) */
        .app-page {
            display: none; /* Hidden by default, JS will show */
        }
        .app-page.active {
            display: block;
        }

        /* Bottom Tab Bar */
        .tab-btn.active svg {
            color: #c058f3;
        }
        .tab-btn.active span {
            color: #c058f3;
        }

        /* Custom input styles */
        .input-glass {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        .input-glass::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        .input-glass:focus {
            outline: none;
            border-color: #c058f3;
            box-shadow: 0 0 0 2px #c058f3;
        }
        select.input-glass {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.4)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            padding-right: 3rem;
        }
        
        /* Custom color picker */
        input[type="color"] {
            -webkit-appearance: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            height: 48px;
            border-radius: 0.5rem;
            cursor: pointer;
            overflow: hidden;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; }

        /* Notification */
        #clipboard-notification {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        /* Custom range slider */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #c058f3;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #c058f3;
            border-radius: 50%;
            cursor: pointer;
        }
        
        /* Cropper.js Styles */
        #cropper-modal {
            z-index: 100; /* Ensure it's on top */
        }
        #cropper-image-container {
            width: 100%;
            height: 60vw; /* 60% of viewport width */
            max-height: 400px;
            background-color: #000;
        }
        #cropper-image {
            display: block;
            max-width: 100%;
        }
        
        /* NEW: Scanner Frame Styles */
        #scanner-frame {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 70vw;
            height: 70vw;
            max-width: 280px;
            max-height: 280px;
        }
        .scanner-corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 6px solid #f5d143; /* brand-yellow */
        }
        #scanner-corner-tl { top: 0; left: 0; border-right: 0; border-bottom: 0; border-top-left-radius: 10px; }
        #scanner-corner-tr { top: 0; right: 0; border-left: 0; border-bottom: 0; border-top-right-radius: 10px; }
        #scanner-corner-bl { bottom: 0; left: 0; border-right: 0; border-top: 0; border-bottom-left-radius: 10px; }
        #scanner-corner-br { bottom: 0; right: 0; border-left: 0; border-top: 0; border-bottom-right-radius: 10px; }
        
        #scanner-laser {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 3px;
            background: #e45b8b; /* brand-pink */
            box-shadow: 0 0 10px #e45b8b;
            animation: scan 3s infinite ease-in-out;
        }
        @keyframes scan {
            0% { transform: translateY(0); }
            50% { transform: translateY(calc(70vw - 3px)); }
            100% { transform: translateY(0); }
        }
        /* Max height animation */
        @media (min-width: 400px) { /* 280px / 0.7 = 400px */
            @keyframes scan {
                0% { transform: translateY(0); }
                50% { transform: translateY(277px); } /* 280px - 3px */
                100% { transform: translateY(0); }
            }
        }
    </style>
</head>
<body class="bg-brand-dark text-white antialiased h-[100dvh] w-screen overflow-hidden">

    <div id="clipboard-notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 z-50">
        Copied to clipboard!
    </div>
    
    <div class="relative h-full w-full">

        <div id="page-get-started" class="page flex flex-col items-center justify-between p-8 bg-brand-dark">
            <div class="flex-grow flex flex-col items-center justify-center text-center">
                <div class="w-40 h-40 card rounded-3xl flex items-center justify-center mb-12 p-4 border-2 border-brand-yellow/30">
                    <svg class="w-24 h-24" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 013.75 9.375v-4.5zM3.75 14.625c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 013.75 19.125v-4.5zM13.5 4.875c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 0113.5 9.375v-4.5z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 14.625c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 0113.5 19.125v-4.5z" />
                    </svg>
                </div>
                <h1 class="text-4xl font-bold mb-4">Get Started</h1>
                <p class="text-lg text-white/70 max-w-xs">Your all-in-one solution for scanning and generating QR codes.</p>
            </div>
            <button id="btn-start" class="w-full max-w-xs bg-brand-gradient text-white font-semibold py-4 px-6 rounded-full shadow-lg transition-transform duration-200 hover:scale-105 active:scale-95">
                Start
            </button>
        </div>

        <div id="page-app-shell" class="page page-hidden flex flex-col h-full bg-brand-dark">
            <div class="flex-grow overflow-y-auto pb-24">
                
                <div id="app-page-main" class="app-page p-6">
                    <h1 class="text-3xl font-bold mb-6">QR Code Generator</h1>
                    
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <button id="btn-goto-generate" class="bg-brand-gradient p-6 rounded-2xl flex flex-col items-center justify-center space-y-3 transition-transform duration-200 hover:scale-105 active:scale-95">
                            <svg class="w-10 h-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                            </svg>
                            <span class="font-semibold">Generate QR</span>
                        </button>
                        <button id="btn-goto-scan" class="card p-6 rounded-2xl flex flex-col items-center justify-center space-y-3 transition-transform duration-200 hover:scale-105 active:scale-95">
                            <svg class="w-10 h-10" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 013.75 9.375v-4.5zM3.75 14.625c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 013.75 19.125v-4.5zM13.5 4.875c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 0113.5 9.375v-4.5z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 14.625c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 0113.5 19.125v-4.5z" />
                            </svg>
                            <span class="font-semibold">Scan QR</span>
                        </button>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-white">Recent QR Codes</h2>
                        <button id="btn-see-all-history" class="text-sm font-medium text-brand-purple hover:text-brand-pink">See All</button>
                    </div>
                    <div id="recent-history-list" class="space-y-3">
                        </div>
                </div>

                <div id="app-page-history" class="app-page p-6">
                    <h1 class="text-3xl font-bold mb-6">History</h1>
                    <div class="flex-grow space-y-6">
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <h2 class="text-xl font-semibold text-white">Generated</h2>
                                <button id="clear-generated-history" class="text-sm text-brand-pink hover:text-brand-pink/80">Clear All</button>
                            </div>
                            <div id="generated-history-list" class="space-y-3">
                                </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <h2 class="text-xl font-semibold text-white">Scanned</h2>
                                <button id="clear-scanned-history" class="text-sm text-brand-pink hover:text-brand-pink/80">Clear All</button>
                            </div>
                            <div id="scanned-history-list" class="space-y-3">
                                </div>
                        </div>
                    </div>
                </div>

            </div>

            <div id="bottom-tab-bar" class="fixed bottom-0 left-0 right-0 h-20 card border-t-0 border-l-0 border-r-0 rounded-t-2xl flex justify-around items-center">
                <button class="tab-btn flex flex-col items-center text-white/50" data-page="app-page-main">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                    </svg>
                    <span class="text-xs font-medium mt-1">Home</span>
                </button>
                <button class="tab-btn flex flex-col items-center text-white/50" data-page="page-generate-type">
                    <svg class="w-10 h-10 p-2 bg-brand-gradient rounded-full -mt-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                </button>
                <button class="tab-btn flex flex-col items-center text-white/50" data-page="app-page-history">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="text-xs font-medium mt-1">History</span>
                </button>
            </div>
        </div>
        
        <div id="page-generate-type" class="page page-hidden flex flex-col p-6 bg-brand-dark overflow-y-auto">
            <div class="flex items-center mb-6 flex-shrink-0">
                <button class="btn-back-to-shell p-2 -ml-2 rounded-full hover:bg-white/10">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                <h1 class="text-2xl font-semibold ml-2">Generate QR Code</h1>
            </div>
            
            <p class="text-white/70 mb-6">What do you want to share?</p>

            <div class="grid grid-cols-2 gap-4">
                <button class="btn-generate-type card p-6 rounded-2xl flex flex-col items-center justify-center space-y-3 transition-transform duration-200 hover:scale-105 active:scale-95" data-type="url">
                    <svg class="w-10 h-10 text-brand-purple" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                    </svg>
                    <span class="font-semibold">URL</span>
                </button>
                <button class="btn-generate-type card p-6 rounded-2xl flex flex-col items-center justify-center space-y-3 transition-transform duration-200 hover:scale-105 active:scale-95" data-type="text">
                    <svg class="w-10 h-10 text-brand-pink" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                    </svg>
                    <span class="font-semibold">Text</span>
                </button>
                <button class="btn-generate-type card p-6 rounded-2xl flex flex-col items-center justify-center space-y-3 transition-transform duration-200 hover:scale-105 active:scale-95" data-type="contact">
                    <svg class="w-10 h-10 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                    </svg>
                    <span class="font-semibold">Contact</span>
                </button>
            </div>
        </div>
        
        <div id="page-generate-contact" class="page page-hidden flex flex-col p-6 bg-brand-dark overflow-y-auto">
            <div class="flex items-center mb-6 flex-shrink-0">
                <button class="btn-back-to-type p-2 -ml-2 rounded-full hover:bg-white/10">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                <h1 class="text-2xl font-semibold ml-2">Create Contact Card</h1>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="contact-name" class="block text-sm font-medium text-white/70 mb-2">Full Name</label>
                    <input type="text" id="contact-name" class="w-full input-glass rounded-lg p-3" placeholder="John Doe">
                </div>
                <div>
                    <label for="contact-phone" class="block text-sm font-medium text-white/70 mb-2">Phone</label>
                    <input type="tel" id="contact-phone" class="w-full input-glass rounded-lg p-3" placeholder="+11234567890">
                </div>
                 <div>
                    <label for="contact-email" class="block text-sm font-medium text-white/70 mb-2">Email</label>
                    <input type="email" id="contact-email" class="w-full input-glass rounded-lg p-3" placeholder="john.doe@example.com">
                </div>
                 <div>
                    <label for="contact-org" class="block text-sm font-medium text-white/70 mb-2">Company (Optional)</label>
                    <input type="text" id="contact-org" class="w-full input-glass rounded-lg p-3" placeholder="Example Inc.">
                </div>
                <button id="btn-create-contact-card" class="w-full bg-brand-gradient text-white font-semibold py-4 px-6 rounded-full shadow-lg transition-transform duration-200 hover:scale-105 active:scale-95">
                    Go to Editor
                </button>
            </div>
        </div>

        <div id="page-scan" class="page page-hidden flex flex-col bg-black">
            <div class="relative w-full h-full overflow-hidden">
                <video id="scan-video" playsinline class="w-full h-full object-cover hidden" style="transform: scaleX(-1);"></video>
                <canvas id="scan-canvas" class="hidden"></canvas>
                
                <div id="scan-ui-overlay" class="absolute inset-0 hidden">
                    <div class="absolute top-0 left-0 right-0 p-4 flex justify-between items-center z-10 bg-black/30">
                        <button class="btn-back-to-shell p-2 rounded-full hover:bg-white/20">
                            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                            </svg>
                        </button>
                        <div class="flex space-x-4">
                            <button id="btn-scan-gallery" class="p-2 rounded-full hover:bg-white/20">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                            </button>
                            <button id="btn-scan-flash" class="p-2 rounded-full hover:bg-white/20">
                                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="scanner-frame">
                        <div id="scanner-corner-tl" class="scanner-corner"></div>
                        <div id="scanner-corner-tr" class="scanner-corner"></div>
                        <div id="scanner-corner-bl" class="scanner-corner"></div>
                        <div id="scanner-corner-br" class="scanner-corner"></div>
                        <div id="scanner-laser"></div>
                    </div>
                </div>
            </div>
             
            <div id="scan-overlay" class="absolute inset-0 p-8 flex flex-col items-center justify-between bg-black/80">
                <div class="w-full flex justify-start">
                    <button class="btn-back-to-shell p-2 rounded-full hover:bg-white/20">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                        </svg>
                    </button>
                </div>
                <div class="flex flex-col items-center text-center">
                    <svg class="w-24 h-24 mb-6 text-white/80" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 013.75 9.375v-4.5zM3.75 14.625c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 013.75 19.125v-4.5zM13.5 4.875c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 0113.5 9.375v-4.5z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 14.625c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 0113.5 19.125v-4.5z" />
                    </svg>
                    <h2 class="text-3xl font-bold mb-2">Ready to Scan</h2>
                    <p class="text-white/60">Tap to start scanning QR codes</p>
                </div>
                <button id="btn-start-scan" class="w-full max-w-xs bg-brand-gradient text-white font-semibold py-4 px-6 rounded-full shadow-lg transition-transform duration-200 hover:scale-105 active:scale-95">
                    Start Camera
                </button>
            </div>
            <input type="file" id="scan-upload-input" accept="image/*" class="hidden">
        </div>

        <div id="page-generate-editor" class="page page-hidden flex flex-col p-6 bg-brand-dark overflow-y-auto">
            <div class="flex items-center mb-6 flex-shrink-0">
                <button class="btn-back-to-shell p-2 -ml-2 rounded-full hover:bg-white/10">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                <h1 id="editor-title" class="text-2xl font-semibold ml-2">QR Code Editor</h1>
            </div>

            <div class="flex flex-col items-center mb-6 card rounded-2xl p-6">
                <div id="qr-canvas-generate" class="w-full max-w-[200px] h-[200px] bg-white rounded-lg flex items-center justify-center">
                    </div>
            </div>

            <div class="space-y-6 pb-24">
                <div>
                    <label for="qr-data" class="block text-sm font-medium text-white/70 mb-2">Data (URL, text, etc.)</label>
                    <textarea id="qr-data" rows="3" class="w-full input-glass rounded-lg p-3" placeholder="https://example.com"></textarea>
                </div>
                
                <div class="card rounded-lg p-4">
                    <label class="text-lg font-semibold">Add Logo</label>
                    <div class="flex items-center space-x-4 mt-3">
                        <input id="logo-upload" type="file" accept="image/png, image/jpeg, image/svg+xml" class="w-full text-sm text-white/70 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-white/10 file:text-white hover:file:opacity-90 transition-all duration-150 ease-in-out">
                        <button id="clear-logo" class="text-brand-pink text-sm flex-shrink-0">Clear</button>
                    </div>
                </div>

                <div class="card rounded-lg p-4">
                    <label class="text-lg font-semibold mb-3 block">Colors</label>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-white/70 mb-2">Dots</label>
                            <input id="dot-color" type="color" value="#c058f3">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-white/70 mb-2">Background</label>
                            <input id="bg-color" type="color" value="#ffffff">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-white/70 mb-2">Corners</label>
                            <input id="corner-dot-color" type="color" value="#0d071a">
                        </div>
                    </div>
                </div>

                <div class="card rounded-lg p-4">
                    <label class="text-lg font-semibold mb-3 block">Style</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="dot-style" class="block text-sm font-medium text-white/70 mb-2">Dot Style</label>
                            <select id="dot-style" class="w-full input-glass rounded-lg p-3">
                                <option value="square">Square</option>
                                <option value="dots">Dots</option>
                                <option value="rounded">Rounded</option>
                                <option value="extra-rounded">Extra Rounded</option>
                                <option value="classy">Classy</option>
                                <option value="classy-rounded">Classy Rounded</option>
                            </select>
                        </div>
                        <div>
                            <label for="corner-square-style" class="block text-sm font-medium text-white/70 mb-2">Corner Style</label>
                            <select id="corner-square-style" class="w-full input-glass rounded-lg p-3">
                                <option value="square">Square</option>
                                <option value="dot">Dot</option>
                                <option value="extra-rounded">Extra Rounded</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="card rounded-lg p-4">
                    <label class="text-lg font-semibold mb-3 block">Margin</label>
                    <div class="flex items-center space-x-4">
                        <input id="qr-margin" type="range" min="0" max="25" value="5" class="w-full">
                        <span id="qr-margin-value" class="text-white/70 w-8 text-right">5</span>
                    </div>
                </div>
            </div>

            <div class=" bottom-0 left-0 right-0 p-6 bg-brand-dark border-t border-white/10">
                <div id="editor-actions-generate">
                     <button id="btn-create-and-save" class="w-full bg-brand-gradient text-white font-semibold py-4 px-6 rounded-full shadow-lg transition-transform duration-200 hover:scale-105 active:scale-95">
                        Create & Save
                    </button>
                </div>
                <div id="editor-actions-edit" class="grid grid-cols-3 gap-4 hidden">
                    <button id="btn-save" class="w-full bg-white/90 hover:bg-white text-brand-dark font-semibold py-3 px-4 rounded-full shadow-lg transition-transform duration-200 hover:scale-105 active:scale-95 flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                        <span>Save</span>
                    </button>
                    <button id="btn-share" class="w-full bg-white/90 hover:bg-white text-brand-dark font-semibold py-3 px-4 rounded-full shadow-lg transition-transform duration-200 hover:scale-105 active:scale-95 flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 100-2.186m0 2.186c-.18-.324-.283-.696-.283-1.093s.103-.77.283-1.093m0 2.186l-9.566-5.314" /></svg>
                        <span>Share</span>
                    </button>
                    <button id="btn-delete" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-full shadow-lg transition-transform duration-200 hover:scale-105 active:scale-95 flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.064 0A48.108 48.108 0 017.625 5.5h8.75a48.108 48.108 0 013.478-.397m-12.064 0L6.18 4.809a2.25 2.25 0 012.244-2.077h8.152a2.25 2.25 0 012.244 2.077L19.23 5.79m-14.456 0h14.456" /></svg>
                        <span>Delete</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="page-result" class="page page-hidden flex flex-col p-6 bg-brand-dark overflow-y-auto">
            <div class="flex items-center mb-6 flex-shrink-0">
                <button class="btn-back-to-shell p-2 -ml-2 rounded-full hover:bg-white/10">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                <h1 class="text-2xl font-semibold ml-2">QR Code</h1>
            </div>

            <div class="flex-grow flex flex-col justify-center space-y-6">
                <div class="flex flex-col items-center card rounded-2xl p-6">
                    <div id="qr-canvas-result" class="w-full max-w-[256px] h-[256px] bg-white rounded-lg flex items-center justify-center">
                        </div>
                </div>
                <div class="card rounded-2xl p-6 space-y-2">
                    <label class="text-sm font-medium text-white/70">Data</label>
                    <p id="result-data-text" class="text-lg break-all">https://example.com</p>
                </div>

                <button id="btn-smart-action" class="w-full bg-brand-gradient text-white font-semibold py-4 px-6 rounded-full shadow-lg transition-transform duration-200 hover:scale-105 active:scale-95">
                    Open Link
                </button>
                
                <div class="card rounded-full p-2 flex justify-around items-center">
                    <button id="btn-copy-result" class="p-4 rounded-full hover:bg-white/10 transition-colors">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.03 1.125 0 1.131.094 1.976 1.057 1.976 2.192V7.5m-9 3v5.25A2.25 2.25 0 006.75 18h10.5a2.25 2.25 0 002.25-2.25V10.5m-12 0h12" /></svg>
                    </button>
                    <button id="btn-share-result" class="p-4 rounded-full hover:bg-white/10 transition-colors">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 100 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186l9.566-5.314m-9.566 7.5l9.566 5.314m0 0a2.25 2.25 0 100-2.186m0 2.186c-.18-.324-.283-.696-.283-1.093s.103-.77.283-1.093m0 2.186l-9.566-5.314" /></svg>
                    </button>
                    <button id="btn-download-png" class="p-4 rounded-full hover:bg-white/10 transition-colors">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    </button>
                    <button id="btn-download-svg" class="p-4 rounded-full hover:bg-white/10 transition-colors">
                        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m3 0H3.75M17.25 7.5l3 2.25-3 2.25m3 0h-3.75M13.5 19.5h-3m3 0V4.5" /></svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="cropper-modal" class="page page-hidden flex flex-col bg-black/80 p-6 justify-center items-center">
            <div class="bg-brand-dark rounded-lg p-6 w-full max-w-sm">
                <h2 class="text-2xl font-semibold mb-4">Crop Logo</h2>
                <div id="cropper-image-container" class="mb-4">
                    <img id="cropper-image" src="">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button id="btn-cancel-crop" class="w-full bg-white/20 hover:bg-white/30 text-white font-semibold py-3 px-4 rounded-full">Cancel</button>
                    <button id="btn-apply-crop" class="w-full bg-brand-gradient text-white font-semibold py-3 px-4 rounded-full">Apply</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- 1. STATE VARIABLES (No DOM) ---
            const GENERATED_HISTORY_KEY = 'qrHistory_generated';
            const SCANNED_HISTORY_KEY = 'qrHistory_scanned';
            let animationFrameId = null;
            let stream = null;
            let currentQRData = "https://example.com";
            let logoImage = null;
            let cropper = null; // Cropper instance
            let currentVideoTrack = null; // NEW: For flash
            let isFlashOn = false; // NEW: Flash state

            // --- 2. DOM ELEMENT VARIABLES ---
            // Page Containers
            const pages = document.querySelectorAll('.page');
            const appPages = document.querySelectorAll('.app-page');
            
            // Tab Bar & Navigation
            const tabButtons = document.querySelectorAll('.tab-btn');
            
            // History Lists
            const generatedHistoryList = document.getElementById('generated-history-list');
            const scannedHistoryList = document.getElementById('scanned-history-list');
            const recentHistoryList = document.getElementById('recent-history-list');
            
            // Editor Elements
            const editorTitle = document.getElementById('editor-title');
            const qrCanvasGenerate = document.getElementById('qr-canvas-generate');
            const dataInput = document.getElementById('qr-data');
            const dotStyleSelect = document.getElementById('dot-style');
            const cornerSquareSelect = document.getElementById('corner-square-style');
            const dotColorInput = document.getElementById('dot-color');
            const bgColorInput = document.getElementById('bg-color');
            const cornerDotColorInput = document.getElementById('corner-dot-color');
            const logoUpload = document.getElementById('logo-upload');
            const clearLogoBtn = document.getElementById('clear-logo');
            
            // Margin Slider
            const marginSlider = document.getElementById('qr-margin');
            const marginValue = document.getElementById('qr-margin-value');
            
            // Editor Button Containers
            const editorActionsGenerate = document.getElementById('editor-actions-generate');
            const editorActionsEdit = document.getElementById('editor-actions-edit');
            
            // Editor Buttons
            const createAndSaveBtn = document.getElementById('btn-create-and-save');
            const saveBtn = document.getElementById('btn-save');
            const shareBtn = document.getElementById('btn-share');
            const deleteBtn = document.getElementById('btn-delete');
            
            // Contact Form
            const createContactBtn = document.getElementById('btn-create-contact-card');
            const contactName = document.getElementById('contact-name');
            const contactPhone = document.getElementById('contact-phone');
            const contactEmail = document.getElementById('contact-email');
            const contactOrg = document.getElementById('contact-org');

            // Result Page Elements
            const qrCanvasResult = document.getElementById('qr-canvas-result');
            const smartActionButton = document.getElementById('btn-smart-action');
            
            // Scanner Elements
            const video = document.getElementById('scan-video');
            const canvasEl = document.getElementById('scan-canvas');
            const canvas = canvasEl.getContext('2d');
            const scanOverlay = document.getElementById('scan-overlay');
            const scanUiOverlay = document.getElementById('scan-ui-overlay'); // NEW
            const startScanBtn = document.getElementById('btn-start-scan');
            const flashBtn = document.getElementById('btn-scan-flash'); // NEW
            const galleryBtn = document.getElementById('btn-scan-gallery'); // NEW
            const scanUploadInput = document.getElementById('scan-upload-input'); // NEW
            
            // Cropper Modal Elements
            const cropperModal = document.getElementById('cropper-modal');
            const cropperImage = document.getElementById('cropper-image');
            const btnApplyCrop = document.getElementById('btn-apply-crop');
            const btnCancelCrop = document.getElementById('btn-cancel-crop');

            // Notification Element
            const notificationEl = document.getElementById('clipboard-notification');
            let notificationTimer;


            // --- 3. QR INSTANCE SETUP ---
            const qrCodeGenerate = new QRCodeStyling({
                width: 200, height: 200, data: currentQRData,
                dotsOptions: { color: "#c058f3", type: "square" },
                backgroundOptions: { color: "#ffffff" },
                cornersSquareOptions: { type: "square" },
                cornersDotOptions: { color: "#0d071a" },
                imageOptions: { crossOrigin: "anonymous", margin: 5, imageSize: 0.4 },
                margin: 5
            });
            qrCodeGenerate.append(qrCanvasGenerate);
            
            const qrCodeResult = new QRCodeStyling({
                width: 256, height: 256, data: currentQRData,
                dotsOptions: { color: "#c058f3", type: "square" },
                backgroundOptions: { color: "#ffffff" },
                cornersSquareOptions: { type: "square" },
                cornersDotOptions: { color: "#0d071a" },
                imageOptions: { crossOrigin: "anonymous", margin: 5, imageSize: 0.4 },
                margin: 5
            });
            qrCodeResult.append(qrCanvasResult);
            
            
            // --- 4. FUNCTION DEFINITIONS ---
            
            // Page Navigation
            function showPage(pageId) {
                if (pageId !== 'page-scan' && stream) {
                    stopScanStream();
                }
                pages.forEach(page => {
                    if (page.id === 'cropper-modal' && pageId !== 'cropper-modal') {
                        return;
                    }
                    page.classList.toggle('page-hidden', page.id !== pageId);
                });
            }

            function showAppPage(pageId) {
                appPages.forEach(page => {
                    page.classList.toggle('active', page.id === pageId);
                });
                tabButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.page === pageId);
                });
            }

            // Helpers
            function showNotification(message, isError = false) {
                clearTimeout(notificationTimer);
                notificationEl.textContent = message;
                notificationEl.classList.toggle('bg-green-500', !isError);
                notificationEl.classList.toggle('bg-red-500', isError);
                notificationEl.classList.remove('opacity-0', 'translate-y-2');
                notificationEl.classList.add('opacity-100', 'translate-y-0');
                
                notificationTimer = setTimeout(() => {
                    notificationEl.classList.remove('opacity-100', 'translate-y-0');
                    notificationEl.classList.add('opacity-0', 'translate-y-2');
                }, 2000);
            }

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('Copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    showNotification('Failed to copy!', true);
                });
            }

            function loadHistory(key) {
                return JSON.parse(localStorage.getItem(key) || '[]');
            }

            function saveHistory(key, history) {
                localStorage.setItem(key, JSON.stringify(history));
            }

            function formatHistoryTimestamp(isoString) {
                const date = new Date(isoString);
                return date.toLocaleString(undefined, { dateStyle: 'short', timeStyle: 'short' });
            }
            
            // Smart Action Helper
            function getDataType(data) {
                if (data.startsWith('http://') || data.startsWith('https://')) {
                    if (data.includes('wa.me/')) return 'whatsapp';
                    return 'url';
                }
                if (data.startsWith('BEGIN:VCARD')) return 'contact';
                if (data.startsWith('tel:')) return 'tel';
                if (data.startsWith('mailto:')) return 'mailto';
                if (data.startsWith('SMSTO:')) return 'sms';
                return 'text';
            }
            
            // Result Page Logic
            function showResultPage(data) {
                currentQRData = data;
                const options = qrCodeGenerate.options; // Get styles from generator
                qrCodeResult.update({
                    data: data,
                    dotsOptions: options.dotsOptions,
                    backgroundOptions: options.backgroundOptions,
                    cornersSquareOptions: options.cornersSquareOptions,
                    cornersDotOptions: options.cornersDotOptions,
                    image: options.image,
                    margin: options.margin
                });
                document.getElementById('result-data-text').textContent = data;
                
                // Update Smart Action Button
                const type = getDataType(data);
                switch(type) {
                    case 'url':
                        smartActionButton.textContent = 'Open Link';
                        smartActionButton.classList.remove('hidden');
                        break;
                    case 'whatsapp':
                        smartActionButton.textContent = 'Open WhatsApp';
                        smartActionButton.classList.remove('hidden');
                        break;
                    case 'contact':
                        smartActionButton.textContent = 'Add Contact';
                        smartActionButton.classList.remove('hidden');
                        break;
                    case 'tel':
                        smartActionButton.textContent = 'Call Number';
                        smartActionButton.classList.remove('hidden');
                        break;
                    case 'mailto':
                        smartActionButton.textContent = 'Send Email';
                        smartActionButton.classList.remove('hidden');
                        break;
                    case 'sms':
                        smartActionButton.textContent = 'Send SMS';
                        smartActionButton.classList.remove('hidden');
                        break;
                    default:
                        smartActionButton.classList.add('hidden'); // Hide for plain text
                }
                
                showPage('page-result');
            }

            // History Logic
            function renderRecentHistory() {
                const genHistory = loadHistory(GENERATED_HISTORY_KEY);
                recentHistoryList.innerHTML = '';
                if (genHistory.length === 0) {
                    recentHistoryList.innerHTML = '<p class="text-white/50 text-sm text-center">No recent codes.</p>';
                    return;
                }
                genHistory.slice(0, 4).forEach(item => {
                    recentHistoryList.appendChild(createHistoryElement(item, 'generated', true));
                });
            }

            function renderHistory() {
                // Generated
                const genHistory = loadHistory(GENERATED_HISTORY_KEY);
                generatedHistoryList.innerHTML = '';
                if (genHistory.length === 0) {
                    generatedHistoryList.innerHTML = '<p class="text-white/50 text-sm">No generated history yet.</p>';
                } else {
                    genHistory.forEach(item => {
                        generatedHistoryList.appendChild(createHistoryElement(item, 'generated'));
                    });
                }
                // Scanned
                const scanHistory = loadHistory(SCANNED_HISTORY_KEY);
                scannedHistoryList.innerHTML = '';
                if (scanHistory.length === 0) {
                    scannedHistoryList.innerHTML = '<p class="text-white/50 text-sm">No scanned history yet.</p>';
                } else {
                    scanHistory.forEach(item => {
                        scannedHistoryList.appendChild(createHistoryElement(item, 'scanned'));
                    });
                }
            }
            
            function createHistoryElement(item, type, isRecent = false) {
                const el = document.createElement('div');
                el.className = 'history-item card p-4 rounded-lg cursor-pointer transition-colors hover:bg-white/20 flex items-center space-x-4';
                el.dataset.historyData = item.data;
                el.dataset.historyType = type;
                
                if (isRecent) {
                    const previewEl = document.createElement('div');
                    previewEl.className = 'w-12 h-12 bg-white rounded-md flex-shrink-0';
                    el.appendChild(previewEl);
                    const qrPreview = new QRCodeStyling({
                        width: 48, height: 48, data: item.data,
                        dotsOptions: { color: "#0d071a", type: "dots" },
                        backgroundOptions: { color: "#ffffff" },
                        image: item.image,
                        margin: 2
                    });
                    qrPreview.append(previewEl);
                }
                
                const textEl = document.createElement('div');
                textEl.className = 'overflow-hidden';
                textEl.innerHTML = `
                    <p class="history-data text-white font-medium break-all truncate">${item.data}</p>
                    <p class="text-xs text-white/50 mt-1">${formatHistoryTimestamp(item.timestamp)}</p>
                `;
                el.appendChild(textEl);
                
                // Click logic separation
                if (type === 'scanned') {
                    // Scanned items open the result page
                    el.addEventListener('click', () => {
                        showResultPage(item.data);
                    });
                } else {
                    // Generated items open the editor
                    el.addEventListener('click', () => {
                        dataInput.value = item.data;
                        logoImage = item.image || null; 
                        // We can't restore styles, so we just load the data and logo
                        updateQRCode(item.data);
                        // NEW: Set editor to "Edit" mode
                        showEditor('edit');
                    });
                }
                return el;
            }
            
            // NEW: Show Editor in specific mode
            function showEditor(mode) {
                if(mode === 'edit') {
                    editorTitle.textContent = 'QR Code Editor';
                    editorActionsGenerate.classList.add('hidden');
                    editorActionsEdit.classList.remove('hidden');
                } else {
                    editorTitle.textContent = 'Generate QR Code';
                    editorActionsGenerate.classList.remove('hidden');
                    editorActionsEdit.classList.add('hidden');
                }
                showPage('page-generate-editor');
            }

            // Generator Logic
            function updateQRCode(dataOverride) {
                const data = dataOverride || dataInput.value || " ";
                currentQRData = data;
                qrCodeGenerate.update({
                    data: data,
                    image: logoImage,
                    dotsOptions: { color: dotColorInput.value, type: dotStyleSelect.value },
                    backgroundOptions: { color: bgColorInput.value },
                    cornersSquareOptions: { type: cornerSquareSelect.value },
                    cornersDotOptions: { color: cornerDotColorInput.value },
                    margin: parseInt(marginSlider.value, 10)
                });
            }
            
            // Contact Card Formatter
            function createVCard() {
                const name = contactName.value;
                const phone = contactPhone.value;
                const email = contactEmail.value;
                const org = contactOrg.value;
                
                if (!name && !phone && !email) {
                    showNotification('Please fill at least one field.', true);
                    return;
                }
                
                let vCard = 'BEGIN:VCARD\nVERSION:3.0\n';
                if (name) vCard += `FN:${name}\n`;
                if (org) vCard += `ORG:${org}\n`;
                if (phone) vCard += `TEL;TYPE=CELL:${phone}\n`;
                if (email) vCard += `EMAIL:${email}\n`;
                vCard += 'END:VCARD';
                
                // Load data into editor
                dataInput.value = vCard;
                clearLogoBtn.click(); // Clear logo for contact cards
                updateQRCode();
                showEditor('generate'); // Show editor in "Generate" mode
            }
            
            // --- NEW: Scanner Functions ---
            async function startScan() {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    
                    video.srcObject = stream;
                    video.setAttribute('playsinline', true);
                    video.play();
                    
                    video.classList.remove('hidden');
                    scanOverlay.classList.add('hidden');
                    scanUiOverlay.classList.remove('hidden');
                    
                    currentVideoTrack = stream.getVideoTracks()[0]; // Save track for flash
                    
                    animationFrameId = requestAnimationFrame(tick);

                } catch (err) {
                    console.error("Error accessing camera:", err);
                    showPage('page-app-shell');
                    showNotification('Error: Could not access camera.', true);
                }
            }

            function stopScanStream() {
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                if (currentVideoTrack) {
                    toggleFlash(false); // Ensure flash is off
                    currentVideoTrack = null;
                }
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                video.srcObject = null;
                video.classList.add('hidden');
                scanUiOverlay.classList.add('hidden');
                scanOverlay.classList.remove('hidden');
                isFlashOn = false;
                flashBtn.classList.remove('text-brand-yellow');
            }

            function toggleFlash(forceState = null) {
                if (!currentVideoTrack) return;
                
                const capabilities = currentVideoTrack.getCapabilities();
                if (!capabilities.torch) {
                    showNotification('Flash is not available on this device.', true);
                    return;
                }
                
                isFlashOn = (forceState !== null) ? forceState : !isFlashOn;
                currentVideoTrack.applyConstraints({
                    advanced: [{ torch: isFlashOn }]
                });
                flashBtn.classList.toggle('text-brand-yellow', isFlashOn);
            }

            function scanImageFromFile(file) {
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        canvasEl.width = img.width;
                        canvasEl.height = img.height;
                        canvas.drawImage(img, 0, 0, img.width, img.height);
                        try {
                            const imageData = canvas.getImageData(0, 0, canvasEl.width, canvasEl.height);
                            const code = jsQR(imageData.data, imageData.width, imageData.height);
                            
                            if (code) {
                                // Save to scanned history
                                const scanHistory = loadHistory(SCANNED_HISTORY_KEY);
                                if (!scanHistory.find(item => item.data === code.data)) {
                                    scanHistory.unshift({ data: code.data, timestamp: new Date().toISOString() });
                                    saveHistory(SCANNED_HISTORY_KEY, scanHistory);
                                }
                                showResultPage(code.data);
                            } else {
                                showNotification('No QR code found in image.', true);
                            }
                        } catch (err) {
                            console.error("jsQR error:", err);
                            showNotification('Could not scan image.', true);
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvasEl.height = video.videoHeight;
                    canvasEl.width = video.videoWidth;
                    canvas.drawImage(video, 0, 0, canvasEl.width, canvasEl.height);
                    try {
                        const imageData = canvas.getImageData(0, 0, canvasEl.width, canvasEl.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                        if (code) {
                            stopScanStream(); // Stop on success
                            
                            // Save to scanned history
                            const scanHistory = loadHistory(SCANNED_HISTORY_KEY);
                            if (!scanHistory.find(item => item.data === code.data)) {
                                scanHistory.unshift({ data: code.data, timestamp: new Date().toISOString() });
                                saveHistory(SCANNED_HISTORY_KEY, scanHistory);
                            }
                            
                            showResultPage(code.data);
                            return;
                        }
                    } catch (err) { console.error("jsQR error:", err); }
                }
                if (animationFrameId) {
                    animationFrameId = requestAnimationFrame(tick);
                }
            }
            

            // --- 5. EVENT LISTENERS ---
            
            // Onboarding & Welcome
            document.getElementById('btn-start').addEventListener('click', () => {
                showPage('page-app-shell');
                renderRecentHistory();
            });
            
            // Main App Buttons
            document.getElementById('btn-goto-generate').addEventListener('click', () => showPage('page-generate-type'));
            document.getElementById('btn-goto-scan').addEventListener('click', () => showPage('page-scan'));
            document.getElementById('btn-see-all-history').addEventListener('click', () => {
                renderHistory();
                showAppPage('app-page-history');
            });

            // Tab Bar
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const pageId = btn.dataset.page;
                    if (pageId.startsWith('app-page-')) {
                        if (pageId === 'app-page-history') renderHistory();
                        if (pageId === 'app-page-main') renderRecentHistory();
                        showAppPage(pageId);
                    } else {
                        showPage(pageId);
                    }
                });
            });

            // Back Buttons (FIXED)
            document.querySelectorAll('.btn-back-to-shell').forEach(btn => {
                btn.addEventListener('click', () => showPage('page-app-shell'));
            });
            document.querySelector('.btn-back-to-type').addEventListener('click', () => showPage('page-generate-type'));

            // Generate Type Buttons
            document.querySelectorAll('.btn-generate-type').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    if (type === 'contact') {
                        // Clear contact form
                        contactName.value = '';
                        contactPhone.value = '';
                        contactEmail.value = '';
                        contactOrg.value = '';
                        showPage('page-generate-contact');
                    } else {
                        // Reset form for URL/Text
                        dataInput.value = (type === 'url') ? 'https://example.com' : 'Your text here';
                        logoImage = null;
                        logoUpload.value = '';
                        marginSlider.value = 5;
                        marginValue.textContent = 5;
                        updateQRCode();
                        showEditor('generate'); // Show editor in "Generate" mode
                    }
                });
            });
            
            // Contact Form Button
            createContactBtn.addEventListener('click', createVCard);

            // History Clear Buttons
            document.getElementById('clear-generated-history').addEventListener('click', () => {
                saveHistory(GENERATED_HISTORY_KEY, []);
                renderHistory();
                renderRecentHistory();
            });
            document.getElementById('clear-scanned-history').addEventListener('click', () => {
                saveHistory(SCANNED_HISTORY_KEY, []);
                renderHistory();
            });

            // Generator Form
            [dataInput, dotStyleSelect, cornerSquareSelect, dotColorInput, bgColorInput, cornerDotColorInput].forEach(el => {
                el.addEventListener('input', () => updateQRCode());
                el.addEventListener('change', () => updateQRCode());
            });
            logoUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        cropperModal.classList.remove('page-hidden');
                        cropperImage.src = event.target.result;
                        if (cropper) cropper.destroy();
                        cropper = new Cropper(cropperImage, {
                            aspectRatio: 1, viewMode: 2, autoCropArea: 0.8,
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });
            clearLogoBtn.addEventListener('click', () => {
                logoImage = null;
                logoUpload.value = '';
                updateQRCode();
            });
            
            marginSlider.addEventListener('input', () => {
                marginValue.textContent = marginSlider.value;
                updateQRCode();
            });
            
            // Function to save code (used by 2 buttons)
            function saveCurrentCode() {
                const data = dataInput.value;
                if (!data || data.trim() === '') {
                    showNotification('Cannot save empty data!', true);
                    return false;
                }
                let history = loadHistory(GENERATED_HISTORY_KEY);
                history = history.filter(item => item.data !== data); 
                history.unshift({ data: data, timestamp: new Date().toISOString(), image: logoImage });
                saveHistory(GENERATED_HISTORY_KEY, history);
                renderRecentHistory();
                return true;
            }

            // Editor Button Listeners
            createAndSaveBtn.addEventListener('click', () => {
                if (saveCurrentCode()) {
                    showNotification('Created & Saved!');
                    showPage('page-app-shell'); // Go back home after creation
                }
            });
            saveBtn.addEventListener('click', () => {
                if (saveCurrentCode()) {
                    showNotification('Changes Saved!');
                }
            });

            shareBtn.addEventListener('click', () => {
                showResultPage(currentQRData);
            });

            deleteBtn.addEventListener('click', () => {
                const data = dataInput.value;
                if (!data || data.trim() === '') {
                    showNotification('Nothing to delete!', true);
                    return;
                }
                let history = loadHistory(GENERATED_HISTORY_KEY);
                const newHistory = history.filter(item => item.data !== data);
                
                if (history.length === newHistory.length) {
                    showNotification('Item not in history.', true);
                } else {
                    saveHistory(GENERATED_HISTORY_KEY, newHistory);
                    showNotification('Deleted from history!');
                    showPage('page-app-shell'); // Go back home
                }
                renderRecentHistory();
            });
            
            // Cropper Modal Button Listeners
            btnApplyCrop.addEventListener('click', () => {
                if (cropper) {
                    logoImage = cropper.getCroppedCanvas({ width: 256, height: 256 }).toDataURL();
                    updateQRCode();
                    cropperModal.classList.add('page-hidden');
                    cropper.destroy();
                    cropper = null;
                    logoUpload.value = '';
                }
            });

            btnCancelCrop.addEventListener('click', () => {
                cropperModal.classList.add('page-hidden');
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                logoUpload.value = '';
            });

            // Result Page Actions
            smartActionButton.addEventListener('click', () => {
                const type = getDataType(currentQRData);
                if (type === 'url' || type === 'whatsapp') {
                    window.open(currentQRData, '_blank');
                } else if (type === 'tel' || type === 'mailto' || type === 'sms') {
                    window.location.href = currentQRData;
                } else if (type === 'contact') {
                    // Create a .vcf file and download it
                    const blob = new Blob([currentQRData], { type: 'text/vcard' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'contact.vcf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            });
            
            document.getElementById('btn-copy-result').addEventListener('click', () => copyToClipboard(currentQRData));
            document.getElementById('btn-share-result').addEventListener('click', () => {
                if (navigator.share) {
                    navigator.share({ title: 'QR Code Data', text: currentQRData, })
                        .catch(err => console.error('Share failed:', err));
                } else {
                    showNotification('Share not supported on this device.', true);
                }
            });
            document.getElementById('btn-download-png').addEventListener('click', () => qrCodeResult.download({ name: 'qr-code', extension: 'png' }));
            document.getElementById('btn-download-svg').addEventListener('click', () => qrCodeResult.download({ name: 'qr-code', extension: 'svg' }));

            // Scanner Page
            startScanBtn.addEventListener('click', startScan);
            flashBtn.addEventListener('click', () => toggleFlash());
            galleryBtn.addEventListener('click', () => scanUploadInput.click());
            scanUploadInput.addEventListener('change', (e) => {
                scanImageFromFile(e.target.files[0]);
                e.target.value = null; // Reset input
            });
            
            
            // --- 6. INITIAL STATE CALLS ---
            dataInput.value = currentQRData; // Set initial form value
            showPage('page-get-started'); // NEW: Start on "Get Started"
            showAppPage('app-page-main'); // Set default app page
            renderRecentHistory(); // Populate recent history on home page
        });
    </script>
</body>
</html>